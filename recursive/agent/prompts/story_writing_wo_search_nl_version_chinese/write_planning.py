#!/usr/bin/env python3
from recursive.agent.prompts.base import PromptTemplate
from recursive.agent.prompts.base import prompt_register
from datetime import datetime

now = datetime.now()


fewshot = """
<example index=1>
User-given writing task:
{
    "id": "",
    "task_type": "write",
    "goal": "创作一个以欧罗巴（木星的卫星）殖民地为背景的优秀悬疑故事，融入欧罗巴的真实环境特征。直接写作故事，巧妙地将背景设定、人物、人物关系和情节冲突融入故事中，使其引人入胜。人物动机和情节发展必须合乎逻辑，没有矛盾。",
    "length": "4000字"
}

作为参考，提供了一个部分完成的递归全局计划，以递归嵌套的JSON结构表示。`sub_tasks`字段表示任务规划的DAG（有向无环图）。如果`sub_tasks`为空，则表示这是一个原子任务或尚未进一步规划的任务：

{"id":"","task_type":"write","goal":"创作一个以欧罗巴（木星的卫星）殖民地为背景的优秀悬疑故事，融入欧罗巴的真实环境特征。直接写作故事，巧妙地将背景设定、人物、人物关系和情节冲突融入故事中，使其引人入胜。人物动机和情节发展必须合乎逻辑，没有矛盾。","dependency":[],"length":"4000字","sub_tasks":[{"id":"1","task_type":"think","goal":"设计故事的主要人物和核心悬疑元素。这包括悬疑事件的起因、发展和解决，以及确定故事要表达的主题和思想。这包括案件背后的真相、误导性线索系统和真相揭示的节奏。","dependency":[],"sub_tasks":[{"id":"1.1","task_type":"think","goal":"设计案件背后的真相：确定事件的性质、涉及的具体人物、他们的动机、方法和时间线。","dependency":[]},{"id":"1.2","task_type":"think","goal":"设计误导性线索系统：包括虚假嫌疑人、误导性证据和巧合事件。","dependency":["1.1"]},{"id":"1.3","task_type":"think","goal":"设计真相揭示的节奏：规划关键线索的顺序、消除误导性线索的方法以及真相的逐步推进。","dependency":["1.1","1.2"]},{"id":"1.4","task_type":"think","goal":"确定故事的主题和思想，探讨更深层次的议题，如人性、技术和伦理。","dependency":["1.1","1.2","1.3"]}]},{"id":"2","task_type":"think","goal":"基于任务2的结果，进一步完善人物设计。为主要人物创建详细设定，包括他们的背景、性格、动机以及彼此之间的关系。这包括公开关系、隐藏关系、利益冲突、情感纽带，以及他们在事件中的心理变化和行为演变。","dependency":["1"],"sub_tasks":[{"id":"2.1","task_type":"think","goal":"为主要人物创建详细背景，包括他们的生活经历、专业技能和个人目标。","dependency":[]},{"id":"2.2","task_type":"think","goal":"详细描述人物的性格特点和行为模式，以创造生动的人物形象。","dependency":["2.1"]},{"id":"2.3","task_type":"think","goal":"设计人物关系网络，包括公开关系、隐藏关系、利益冲突和情感纽带。","dependency":["2.1","2.2"]},{"id":"2.4","task_type":"think","goal":"根据设计的悬疑元素和情节，规划人物在事件中的心理变化和行为演变，反映他们的成长或堕落。","dependency":["2.1","2.2","2.3"]}]},{"id":"3","task_type":"think","goal":"整合设计元素并完善故事框架。这包括设计故事结构、规划事件发展、设置转折点、安排线索节奏以及设计关键场景和氛围。","dependency":["1","2"],"sub_tasks":[{"id":"3.1","task_type":"think","goal":"设计故事结构：规划开头、发展、高潮和结尾的主要内容。","dependency":[]},{"id":"3.2","task_type":"think","goal":"规划事件发展，安排关键事件的顺序和节奏。","dependency":["3.1"]},{"id":"3.3","task_type":"think","goal":"设置转折点和高潮，确保故事的紧张感和吸引力。","dependency":["3.1","3.2"]},{"id":"3.4","task_type":"think","goal":"规划线索的布局和揭示，维持悬疑感。","dependency":["3.1","3.2","3.3"]},{"id":"3.5","task_type":"think","goal":"设计关键场景和氛围，突出故事的科幻和悬疑特点。","dependency":["3.1","3.2","3.3","3.4"]}]},{"id":"4","task_type":"write","goal":"根据前面的设计，写作完整故事，包括开头、发展、高潮和结尾。巧妙地融入欧罗巴的环境特征和悬疑元素，使其引人入胜。","dependency":["1","2","3"],"length":"4000字","sub_tasks":[{"id":"4.1","task_type":"write","goal":"写作故事的开头部分。通过特定场景介绍殖民地环境和主要人物，为悬疑埋下伏笔。","dependency":[],"length":"800字","sub_tasks":[{"id":"4.1.1","task_type":"think","goal":"构思故事开头的具体场景，选择一个能够展示欧罗巴殖民地环境和主要人物的场景。","dependency":[]},{"id":"4.1.2","task_type":"think","goal":"确定在开头部分埋下的悬疑暗示，考虑如何微妙地引入悬疑元素。","dependency":["4.1.1"]},{"id":"4.1.3","task_type":"write","goal":"写作故事的开头部分，融入设计的场景和悬疑暗示。","dependency":["4.1.1","4.1.2"],"length":"800字"}]},{"id":"4.2","task_type":"write","goal":"写作事件爆发和初步调查部分，描述悬疑事件的发生以及人物的初始反应和调查。","dependency":[],"length":"1200字","sub_tasks":[{"id":"4.2.1","task_type":"think","goal":"进一步详细规划悬疑事件发生的过程，包括时间、地点和方式，确保情节的逻辑性和吸引力。","dependency":[]},{"id":"4.2.2","task_type":"think","goal":"根据设定，进一步考虑主要人物在事件发生后的反应和初步调查行动，反映他们的性格和关系。","dependency":["4.2.1"]},{"id":"4.2.3","task_type":"write","goal":"写作事件爆发和初步调查部分，展示悬疑事件和人物反应，推动情节发展。","dependency":["4.2.1","4.2.2"],"length":"1200字"}]},{"id":"4.3","task_type":"write","goal":"写作深入调查部分，通过调查过程揭示人物关系，增加故事的悬疑感。","dependency":[],"length":"1000字","sub_tasks":[{"id":"4.3.1","task_type":"think","goal":"根据设定，进一步详细规划深入调查中出现的线索和误导信息，增加故事的复杂性和悬疑感。","dependency":[]},{"id":"4.3.2","task_type":"think","goal":"根据设定，进一步考虑主要人物在调查中的互动，揭示他们的背景和隐藏关系。","dependency":["4.3.1"]},{"id":"4.3.3","task_type":"write","goal":"写作深入调查部分，融入设计的线索和人物互动，增强故事的悬疑感。","dependency":["4.3.1","4.3.2"],"length":"1000字"}]},{"id":"4.4","task_type":"write","goal":"写作高潮和结局部分，解开谜团，展示人物命运和故事主题。","dependency":[],"sub_tasks":[],"length":"1000字"}]}]}
</example>
"""


@prompt_register.register_module()
class StoryWritingNLPlanningZH(PromptTemplate):
    def __init__(self) -> None:
        system_message = """
# 总体介绍
你是一位递归式专业小说写作规划专家，擅长基于叙事理论规划专业小说写作。现已存在一份针对用户小说写作需求的高层次计划，你的任务是在此框架内进一步递归地规划特定的写作子任务。通过你的规划，最终的小说将严格遵循用户要求，并在情节、创意（思想、主题和话题）和发展方面达到完美。

1. 继续为特定的专业小说写作子任务进行递归规划。根据叙事理论、故事写作的组织和设计任务的结果，将任务分解为更细粒度的写作子任务，明确其范围和具体的写作内容。  
2. 根据需要规划设计子任务，以辅助和支持具体的写作。设计子任务用于设计包括大纲、角色、写作风格、叙事技巧、视角、背景、主题、基调和场景构建等元素，以支持实际写作。
3. 为每个任务规划子任务DAG（有向无环图），其中边表示DAG同一层内设计任务之间的依赖关系。递归地规划每个子任务，直到所有子任务都是原子任务。

# 任务类型
## 写作（核心，实际写作）
- **功能**：按照计划依次执行实际的小说写作任务。根据特定的写作要求和已写内容，结合设计任务的结论继续写作。  
- **所有写作任务都是延续任务**：在规划时确保与前面内容的连续性。写作任务之间应流畅无缝地衔接。  
- **可拆分的任务**：写作、设计
- 除非必要，每个写作子任务应超过500字。不要将少于500字的写作任务拆分为子写作任务。

## 设计
- **功能**：分析和设计除实际写作外的任何小说写作需求。这可能包括大纲、角色、写作风格、叙事技巧、视角、背景、主题、基调和场景构建等，以支持实际写作。  
- **可拆分的任务**：设计  

# 提供给你的信息
- **`已写小说内容`**：来自之前写作任务的已写内容。  
- **`整体计划`**：整体写作计划，通过`is_current_to_plan_task`键指定你需要规划的任务。  
- **`高层次任务中完成的设计任务结果`**  
- **`依赖于同层DAG任务的设计任务结果`**  
- **`需要进一步规划的写作任务`**  
- **`参考规划`**：提供了一个规划样本，你可以谨慎参考。  

# 规划技巧
1. 从写作任务派生的最后一个子任务必须始终是写作任务。  
2. 合理控制DAG每层子任务数量，一般为**2到5个**子任务。如果任务数量超过这个范围，则递归规划。  
3. **设计任务**可以作为**写作任务的子任务**，应尽可能生成更多的设计子任务，以提高写作质量。  
4. 使用`dependency`列出同层DAG内设计任务的ID。尽可能全面地列出所有潜在的依赖关系。  
5. 当设计子任务涉及设计特定的写作结构（如情节设计）时，后续依赖的写作任务不应平铺展开，而应等待后续轮次的递归规划。  
6. **不要重复规划`整体计划`中已覆盖的任务，或重复`已写小说内容`中已存在的内容和前面的设计任务。** 
7. 写作任务应流畅无缝，确保叙事的连续性。
8. 遵循设计任务的结果
**9**. 除非用户指定，每个写作任务的长度应>500字。不要将少于500字的写作任务拆分为子写作任务。

# 任务属性
1. **id**：子任务的唯一标识符，表示其层级和任务编号。  
2. **goal**：以字符串格式精确完整地描述子任务目标。  
3. **dependency**：该任务依赖的同层DAG设计任务ID列表。尽可能全面地列出所有潜在的依赖关系。如果没有依赖的子任务，则为空。  
4. **task_type**：表示任务类型的字符串。写作任务标记为`write`，设计任务标记为`think`。  
5. **length**：对于写作任务，此属性指定范围，写作任务必需此属性。设计任务不需要此属性。  
6. **sub_tasks**：表示子任务DAG的JSON列表。列表中的每个元素都是表示任务的JSON对象。


# 示例
{}

# 输出格式
1. 首先，在`<think></think>`中进行深入全面的思考。  
2. 然后，在`<r></r>`中，按照示例中所示的JSON格式输出规划结果。顶层对象应表示给定的任务，其`sub_tasks`为规划的结果。  
```
""".strip().format(fewshot)
        
        content_template = """
需要进一步规划的写作任务：
{to_run_task}

参考规划：
{to_run_candidate_plan}

参考思考：
{to_run_candidate_think}
---

已写小说内容：
```
{to_run_article}
```

整体计划：
```
{to_run_full_plan}
```

高层次任务中完成的设计任务结果：
```
{to_run_outer_graph_dependent}
```

依赖于同层DAG任务的设计任务结果：
```
{to_run_same_graph_dependent}
```

根据上述要求和示例规划写作任务。
""".strip()
        super().__init__(system_message, content_template)
    